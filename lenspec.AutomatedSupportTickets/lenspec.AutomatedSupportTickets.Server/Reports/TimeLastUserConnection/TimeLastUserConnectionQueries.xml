<?xml version="1.0" encoding="utf-8"?>
<queries>
  <query key="QueryForTimeLastUserConnection">
    <mssql><![CDATA[Set language russian;

select businessUnit.[Name] as Organization, department.[Name] as Division, employee.[Name] as Username, 
ISNULL(CAST(convert(datetime,historyLogin.[HistoryDate],104) as varchar), 'Подключение отсутствует') as LoginDate,
ISNULL(CAST(convert(datetime,historyLogout.[HistoryDate],104) as varchar), 'Подключение отсутствует') as LogoutDate
from Sungero_Core_Recipient employee
Full join Sungero_Core_SystemHistory historyLogin on historyLogin.[User] = employee.[Id] and historyLogin.HistoryDate between @beginDate and @endDate and historyLogin.[Operation] = 'Login'
inner join Sungero_Core_Recipient department on employee.[Department_Company_Sungero] = department.[Id]
inner join Sungero_Core_Recipient businessUnit on department.[BusinessUnit_Company_Sungero] = businessUnit.[Id]
left join Sungero_Core_SystemHistory historyLogout on historyLogin.Comment = historyLogout.Comment and historyLogout.[Operation] = 'Logout' and historyLogin.[HistoryDate] < historyLogout.[HistoryDate]
where employee.[Id] in (select value from string_split(@Employee, ',')) 
order by employee.[Name], historyLogin.HistoryDate;]]></mssql>
  </query>
</queries>